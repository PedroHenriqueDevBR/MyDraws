{% extends "base_site.html" %}

{% block title %}Comprar Créditos{% endblock %}

{% block content %}

<style>
    .credit-package {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .credit-package:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .credit-package.selected {
        border-color: #007bff !important;
        background-color: #E1F5FE;
    }
</style>

<div class="container mx-auto mt-10">
    <div>
        <div class="px-6 py-4 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-coins mr-2"></i> Comprar Créditos
            </h1>
            <p class="text-sm text-gray-500">Adicione créditos à sua conta para usar recursos premium</p>
        </div>

        <div class="px-6 py-4 mt-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-6">
                        <h6 class="text-lg font-semibold text-gray-800">Saldo Atual</h6>
                        <div class="bg-blue-100 text-blue-800 p-4 rounded-lg flex items-center">
                            <i class="fas fa-wallet mr-2"></i>
                            <strong>{{ user.credit_amount }} créditos</strong>
                        </div>
                    </div>

                    <h2 class="text-xl font-semibold text-gray-800">Pacotes Disponíveis</h2>

                    <div class="space-y-4">
                        <!-- Pacote Básico -->
                        <div class="border rounded-lg p-4 cursor-pointer transition-transform transform hover:-translate-y-1 hover:shadow-lg credit-package"
                            data-credits="50" data-price="37.50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h6 class="text-lg font-semibold text-gray-800">Pacote Básico</h6>
                                    <p class="text-sm text-gray-500">50 créditos</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xl font-bold text-gray-800">R$ 37,50</span>
                                    <br>
                                    <small class="text-gray-500">R$ {{ unit_price|floatformat:2 }} por crédito</small>
                                </div>
                            </div>
                        </div>

                        <!-- Pacote Popular -->
                        <div class="border border-blue-500 rounded-lg p-4 cursor-pointer transition-transform transform hover:-translate-y-1 hover:shadow-lg credit-package"
                            data-credits="120" data-price="81.60">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h6 class="text-lg font-semibold text-gray-800">
                                        Pacote Popular
                                        <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded">Mais vendido</span>
                                    </h6>
                                    <p class="text-sm text-gray-500">120 créditos</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xl font-bold text-gray-800">R$ 81,60</span>
                                    <br>
                                    <small class="text-green-500">R$ {{ medium_price|floatformat:2 }} por crédito</small>
                                </div>
                            </div>
                        </div>

                        <!-- Pacote Premium -->
                        <div class="border border-yellow-500 rounded-lg p-4 cursor-pointer transition-transform transform hover:-translate-y-1 hover:shadow-lg credit-package"
                            data-credits="300" data-price="180.00">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h6 class="text-lg font-semibold text-gray-800">
                                        Pacote Premium
                                        <span class="bg-yellow-500 text-gray-800 text-xs px-2 py-1 rounded">Melhor valor</span>
                                    </h6>
                                    <p class="text-sm text-gray-500">300 créditos</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xl font-bold text-gray-800">R$ 180,00</span>
                                    <br>
                                    <small class="text-green-500">R$ {{ premium_price|floatformat:2 }} por crédito</small>
                                </div>
                            </div>
                        </div>

                        <!-- Pacote Customizado -->
                        <div class="border rounded-lg p-4 cursor-pointer transition-transform transform hover:-translate-y-1 hover:shadow-lg credit-package"
                            data-credits="custom" data-price="custom">
                            <h6 class="text-lg font-semibold text-gray-800 mb-4">Pacote Personalizado</h6>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="customCredits" class="block text-sm font-medium text-gray-700">Créditos</label>
                                    <input type="number" id="customCredits" class="mt-1 block w-full border-gray-500 px-2 py-2 focus:ring-blue-500 focus:border-blue-500"
                                        min="5" max="1000" value="100" onchange="updateCustomPrice()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Total</label>
                                    <div class="mt-1">
                                        <strong id="customTotal" class="text-lg text-gray-800">R$ 75,00</strong>
                                        <br>
                                        <small id="customUnitPrice" class="text-gray-500">R$ {{ unit_price|floatformat:2 }} por crédito</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="p-4 rounded-lg">
                        <h6 class="text-lg font-semibold text-gray-800">Resumo da Compra</h6>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div id="selectedPackage" class="mb-4">
                                <p class="text-sm text-gray-500">Selecione um pacote ao lado</p>
                            </div>

                            <div id="paymentDetails" class="hidden">
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm text-gray-800">Créditos:</span>
                                    <strong id="summaryCredits" class="text-sm text-gray-800">-</strong>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm text-gray-800">Preço unitário:</span>
                                    <span id="summaryUnitPrice" class="text-sm text-gray-800">-</span>
                                </div>
                                <hr class="my-2">
                                <div class="flex justify-between mb-4">
                                    <strong class="text-lg text-gray-800">Total:</strong>
                                    <strong id="summaryTotal" class="text-lg text-blue-500">-</strong>
                                </div>

                                <button class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition" onclick="processPayment()">
                                    <i class="fas fa-credit-card mr-2"></i> Pagar com Mercado Pago
                                </button>
                            </div>
                        </div>

                        <div class="mt-4 text-sm text-gray-500 flex items-center">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Pagamento seguro processado pelo Mercado Pago
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedCredits = 0;
    let selectedPrice = 0;
    let unitPriceDefault = parseFloat("{{ unit_price_str }}");
    console.log(`Unit Price: ${unitPriceDefault}`);

    // Selecionar pacote de créditos
    document.querySelectorAll('.credit-package').forEach(package => {
        package.addEventListener('click', function () {
            // Remove seleção anterior
            document.querySelectorAll('.credit-package').forEach(p => p.classList.remove('selected'));

            // Adiciona seleção atual
            this.classList.add('selected');

            const credits = this.dataset.credits;
            const price = this.dataset.price;

            if (credits === 'custom') {
                selectedCredits = parseInt(document.getElementById('customCredits').value);
                selectedPrice = parseFloat(document.getElementById('customCredits').value) * unitPriceDefault;
            } else {
                selectedCredits = parseInt(credits);
                selectedPrice = parseFloat(price);
            }

            updatePaymentSummary();
        });
    });

    function updateCustomPrice() {
        const credits = parseInt(document.getElementById('customCredits').value);
        const unitPrice = unitPriceDefault;
        console.log(`Unit Price: ${unitPrice}`);
        console.log(`Credits: ${credits}`);
        const total = credits * unitPriceDefault;

        document.getElementById('customTotal').textContent = `R$ ${total.toFixed(2)}`;
        document.getElementById('customUnitPrice').textContent = `R$ ${unitPrice.toFixed(2)} por crédito`;

        // Se o pacote personalizado estiver selecionado, atualiza o resumo
        if (document.querySelector('.credit-package[data-credits="custom"]').classList.contains('selected')) {
            selectedCredits = credits;
            selectedPrice = total;
            updatePaymentSummary();
        }
    }

    function updatePaymentSummary() {
        if (selectedCredits > 0) {
            document.getElementById('selectedPackage').style.display = 'none';
            document.getElementById('paymentDetails').style.display = 'block';

            document.getElementById('summaryCredits').textContent = `${selectedCredits} créditos`;
            document.getElementById('summaryUnitPrice').textContent = `R$ ${(selectedPrice / selectedCredits).toFixed(2)}`;
            document.getElementById('summaryTotal').textContent = `R$ ${selectedPrice.toFixed(2)}`;
        }
    }

    async function processPayment() {
        if (selectedCredits <= 0) {
            alert('Selecione um pacote de créditos primeiro.');
            return;
        }

        try {
            const response = await fetch('/payment/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    credit_amount: selectedCredits,
                })
            });

            const data = await response.json();

            if (data.success) {
                // Redireciona para o Mercado Pago
                window.location.href = data.init_point;
            } else {
                alert(`Erro ao criar pagamento: ${data.error}`);
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro interno. Tente novamente.');
        }
    }

    // Inicializa com pacote popular selecionado
    document.querySelector('.credit-package[data-credits="120"]').click();
</script>

{% csrf_token %}
{% endblock %}