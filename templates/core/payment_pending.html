{% extends "base.html" %}

{% block title %}Pagamento Pendente{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark text-center">
                    <h4><i class="fas fa-clock"></i> Pagamento em Processamento</h4>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-hourglass-half fa-3x text-warning mb-3"></i>
                        <h5>Seu pagamento está sendo processado</h5>
                    </div>
                    
                    <div class="alert alert-info">
                        <p class="mb-1">Aguarde alguns instantes...</p>
                        <p class="mb-0">Você receberá uma confirmação assim que o pagamento for aprovado.</p>
                    </div>
                    
                    {% if payment_id %}
                    <div class="mb-3">
                        <small class="text-muted">ID do Pagamento: {{ payment_id }}</small>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Verificando...</span>
                        </div>
                        <p class="mt-2 text-muted">Verificando status do pagamento...</p>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="checkPaymentStatus()" id="checkBtn">
                            <i class="fas fa-sync"></i> Verificar Status
                        </button>
                        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-home"></i> Voltar ao Início
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const paymentId = '{{ payment_id }}';

async function checkPaymentStatus() {
    if (!paymentId) return;
    
    const checkBtn = document.getElementById('checkBtn');
    const originalText = checkBtn.innerHTML;
    
    try {
        checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
        checkBtn.disabled = true;
        
        const response = await fetch(`/payment/status/${paymentId}/`);
        const data = await response.json();
        
        if (data.success) {
            const status = data.payment.status;
            
            if (status === 'approved') {
                // Pagamento aprovado - redireciona para página de sucesso
                window.location.href = `/payment/success/?payment_id=${paymentId}&status=approved`;
            } else if (status === 'rejected' || status === 'cancelled') {
                // Pagamento rejeitado - redireciona para página de erro
                window.location.href = `/payment/failure/?payment_id=${paymentId}&status=${status}`;
            } else {
                // Ainda pendente
                alert('Pagamento ainda em processamento. Aguarde mais um pouco.');
            }
        } else {
            alert('Erro ao verificar status do pagamento.');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao verificar status do pagamento.');
    } finally {
        checkBtn.innerHTML = originalText;
        checkBtn.disabled = false;
    }
}

// Verifica automaticamente a cada 15 segundos
if (paymentId) {
    const autoCheck = setInterval(async () => {
        try {
            const response = await fetch(`/payment/status/${paymentId}/`);
            const data = await response.json();
            
            if (data.success) {
                const status = data.payment.status;
                
                if (status === 'approved') {
                    clearInterval(autoCheck);
                    window.location.href = `/payment/success/?payment_id=${paymentId}&status=approved`;
                } else if (status === 'rejected' || status === 'cancelled') {
                    clearInterval(autoCheck);
                    window.location.href = `/payment/failure/?payment_id=${paymentId}&status=${status}`;
                }
            }
        } catch (error) {
            console.error('Erro na verificação automática:', error);
        }
    }, 15000);
    
    // Para a verificação automática após 10 minutos
    setTimeout(() => clearInterval(autoCheck), 600000);
}
</script>
{% endblock %}
